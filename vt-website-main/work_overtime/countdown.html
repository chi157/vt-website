<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å€’æ•¸è¨ˆæ™‚å™¨ - æŸ’æŸ’ chi</title>
    <link rel="icon" type="image/png" href="../images/é ­è²¼%20-%20åœ“å½¢.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family);
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-image: 
          radial-gradient(circle at 20% 50%, rgba(125, 211, 252, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(192, 132, 252, 0.1) 0%, transparent 50%);
      }

      .countdown-container {
        text-align: center;
        max-width: 1400px;
        width: 100%;
      }

      .countdown-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 3rem;
        width: 100%;
      }

      .side-image {
        object-fit: contain;
        flex-shrink: 0;
        max-width: 200px;
      }

      .side-image.left {
        animation: floatLeft 3s ease-in-out infinite;
      }

      .side-image.right {
        animation: floatRight 3s ease-in-out infinite;
      }

      @keyframes floatLeft {
        0%, 100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      @keyframes floatRight {
        0%, 100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .countdown-title {
        font-size: 2.5rem;
        font-weight: 900;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .countdown-message {
        font-size: 1.5rem;
        margin-bottom: 3rem;
        opacity: 0.9;
      }

      .countdown-display {
        display: flex;
        justify-content: center;
        gap: 2rem;
        flex-wrap: nowrap;
        margin-bottom: 3rem;
      }

      .time-unit {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(125, 211, 252, 0.2);
        border-radius: 20px;
        padding: 2rem 1.5rem;
        min-width: 140px;
        transition: all 0.3s ease;
      }

      .time-unit:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
        box-shadow: 0 10px 30px rgba(125, 211, 252, 0.3);
      }

      .time-value {
        font-size: 4rem;
        font-weight: 900;
        line-height: 1;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }

      .time-label {
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        opacity: 0.7;
      }

      .end-message {
        font-size: 3rem;
        font-weight: 900;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.9;
        }
      }

      .back-button {
        margin-top: 2rem;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        display: inline-block;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .back-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(125, 211, 252, 0.4);
      }

      .add-time-animation {
        position: absolute;
        color: #7dd3fc;
        font-size: 2rem;
        font-weight: bold;
        pointer-events: none;
        animation: addTimeAnim 2s ease-out forwards;
        z-index: 10;
      }

      @keyframes addTimeAnim {
        0% { transform: translateY(-50px); opacity: 0; }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { transform: translateY(0); opacity: 0; }
      }
    </style>
  </head>
  <body>
    <div class="countdown-container">
      <h1 class="countdown-title" id="title">å€’æ•¸è¨ˆæ™‚å™¨</h1>
      <p class="countdown-message" id="message">è¼‰å…¥ä¸­...</p>
      
      <div class="countdown-wrapper">
        <img src="../images/è²“é ­é·¹é£›èµ·ä¾†.png" alt="è²“é ­é·¹" class="side-image left" id="leftImage">
        
        <div class="countdown-display" id="countdownDisplay">
          <!-- å€’æ•¸è¨ˆæ™‚å™¨æœƒåœ¨é€™è£¡é¡¯ç¤º -->
        </div>
        
        <img src="../images/äººé£›èµ·ä¾†.png" alt="äººç‰©" class="side-image right" id="rightImage">
      </div>
      
    </div>

    <!-- è¼‰å…¥è¨­å®šæª” -->
    <script src="countdown-config.js"></script>
    
    <!-- å€’æ•¸è¨ˆæ™‚å™¨é‚è¼¯ -->
    <script>
      let currentInterval = null;
      let targetTime = null;
      let config = null;
      let lastServerSync = 0;
      let lastDays = null, lastHours = null, lastMinutes = null, lastSeconds = null;
      
      // å¾ä¼ºæœå™¨è¼‰å…¥è¨­å®š
      async function loadFromServer() {
        try {
          const response = await fetch('get-countdown.php?t=' + Date.now(), { cache: 'no-cache' });
          const result = await response.json();
          
          if (result.success && result.data) {
            console.log('â˜ï¸ å¾ä¼ºæœå™¨è¼‰å…¥è¨­å®š:', result.data);
            return result.data;
          }
        } catch (e) {
          console.error('âŒ ç„¡æ³•å¾ä¼ºæœå™¨è¼‰å…¥:', e);
        }
        return null;
      }
      
      // è¼‰å…¥ä¸¦æ‡‰ç”¨è¨­å®š
      async function loadAndApplyConfig() {
        // å…ˆæª¢æŸ¥ URL åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const minutesParam = urlParams.get('minutes');
        if (minutesParam) {
          // å¦‚æœ URL æœ‰æŒ‡å®šåˆ†é˜æ•¸ï¼Œå„ªå…ˆä½¿ç”¨
          const minutes = parseInt(minutesParam);
          if (minutes > 0) {
            config = {
              ...countdownConfig,
              targetTimestamp: Date.now() + (minutes * 60 * 1000),
              isPaused: false
            };
            console.log(`ğŸŒ ä½¿ç”¨ URL åƒæ•¸: ${minutes} åˆ†é˜`);
            applyConfigStyles();
            return config;
          }
        }
        
        // å„ªå…ˆå¾ä¼ºæœå™¨è¼‰å…¥
        const serverConfig = await loadFromServer();
        if (serverConfig) {
          config = {
            ...countdownConfig,
            ...serverConfig,
            theme: countdownConfig.theme
          };
          console.log('âœ… å·²è¼‰å…¥ä¼ºæœå™¨è¨­å®š');
          applyConfigStyles();
          return config;
        }
        
        // å‚™ç”¨ï¼šè®€å– localStorage
        const savedConfig = localStorage.getItem('countdownConfig');
        
        if (savedConfig) {
          try {
            const userConfig = JSON.parse(savedConfig);
            // åˆä½µè¨­å®šï¼šä½¿ç”¨è€…è¨­å®šå„ªå…ˆï¼Œä½†ä¿ç•™ä¸»é¡Œè¨­å®š
            config = {
              ...countdownConfig,
              ...userConfig,
              theme: countdownConfig.theme // ä¿ç•™ä¸»é¡Œè¨­å®š
            };
            console.log('âœ… å·²è¼‰å…¥æ§åˆ¶é¢æ¿è¨­å®š', config);
          } catch (e) {
            console.error('è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­è¨­å®š', e);
            config = countdownConfig;
          }
        } else {
          // æ²’æœ‰å„²å­˜çš„è¨­å®šï¼Œé è¨­ç‚ºæš«åœä¸‰å°æ™‚
          config = {
            ...countdownConfig,
            isPaused: true,
            remainingMs: 180 * 60 * 1000
          };
          console.log('âš ï¸ æ²’æœ‰å„²å­˜çš„è¨­å®šï¼Œé è¨­æš«åœä¸‰å°æ™‚', config);
        }

        applyConfigStyles();
        return config;
      }
      
      // æ‡‰ç”¨æ¨£å¼è¨­å®š
      function applyConfigStyles() {
        // è¨­å®š CSS è®Šæ•¸
        document.documentElement.style.setProperty('--bg-color', config.theme.backgroundColor);
        document.documentElement.style.setProperty('--primary-color', config.theme.primaryColor);
        document.documentElement.style.setProperty('--secondary-color', config.theme.secondaryColor);
        document.documentElement.style.setProperty('--text-color', config.theme.textColor);
        document.documentElement.style.setProperty('--font-family', config.theme.fontFamily);

        // è¨­å®šæ¨™é¡Œå’Œè¨Šæ¯
        document.getElementById('title').textContent = config.title;
        document.getElementById('message').textContent = config.message;

        // è¨ˆç®—ç›®æ¨™æ™‚é–“ï¼ˆä½¿ç”¨æ™‚é–“æˆ³è¨˜ï¼‰
        if (config.targetTimestamp) {
          targetTime = config.targetTimestamp;
          console.log('ğŸ¯ è¨­å®šç›®æ¨™æ™‚é–“:', new Date(targetTime).toLocaleString('zh-TW'), 'isPaused:', config.isPaused);
        } else if (config.targetDate) {
          // ç›¸å®¹èˆŠæ ¼å¼
          targetTime = new Date(config.targetDate).getTime();
          console.log('ğŸ¯ ç›®æ¨™æ™‚é–“ (èˆŠæ ¼å¼):', new Date(targetTime).toLocaleString('zh-TW'));
        } else {
          // é è¨­ï¼š3å°æ™‚å¾Œ
          targetTime = Date.now() + (180 * 60 * 1000);
          console.log('âš ï¸ ä½¿ç”¨é è¨­3å°æ™‚');
        }
      }
      
      // åˆå§‹åŒ–è¨­å®š
      loadAndApplyConfig().then(() => {
        // æ›´æ–°å€’æ•¸è¨ˆæ™‚å™¨
        updateCountdown();
        
        // åˆå§‹åŒ–åœ–ç‰‡é«˜åº¦
        setTimeout(adjustSideImagesHeight, 100);
        
        // å•Ÿå‹•å®šæ™‚å™¨
        startCountdownInterval();
        
        // å®šæœŸå¾ä¼ºæœå™¨åŒæ­¥è¨­å®šï¼ˆæ¯ 0.5 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰
        setInterval(async () => {
          const serverConfig = await loadFromServer();
          if (serverConfig && 
              (serverConfig.targetTimestamp !== config.targetTimestamp || 
               serverConfig.isPaused !== config.isPaused ||
               serverConfig.remainingMs !== config.remainingMs)) {
            console.log('âš¡ æ”¶åˆ°ä¼ºæœå™¨æ¨é€æ›´æ–°:', serverConfig);
            config = {
              ...countdownConfig,
              ...serverConfig,
              theme: countdownConfig.theme
            };
            applyConfigStyles();
            updateCountdown(); // ç«‹å³æ›´æ–°é¡¯ç¤º
          }
        }, 500);
      });

      // æ›´æ–°å€’æ•¸è¨ˆæ™‚å™¨
      function updateCountdown() {
        // æª¢æŸ¥æ˜¯å¦æš«åœ
        if (config.isPaused) {
          // é¡¯ç¤ºæš«åœè¨Šæ¯
          const remainingMinutes = Math.floor(config.remainingMs / 60000);
          const remainingSeconds = Math.floor((config.remainingMs % 60000) / 1000);
          
          document.getElementById('countdownDisplay').innerHTML = 
            `<div class="end-message" style="font-size: 2rem; opacity: 0.7;">
              â¸ï¸ å·²æš«åœ<br>
              <span style="font-size: 1.5rem;">å‰©é¤˜ ${remainingMinutes} åˆ† ${remainingSeconds} ç§’</span>
            </div>`;
          return;
        }

        const now = new Date().getTime();
        const distance = targetTime - now;

        if (distance < 0) {
          // å€’æ•¸çµæŸ
          document.getElementById('countdownDisplay').innerHTML = 
            `<div class="end-message">${config.endMessage}</div>`;
          
          if (config.onCountdownEnd) {
            config.onCountdownEnd();
          }
          
          if (config.autoReloadOnEnd) {
            setTimeout(() => location.reload(), 3000);
          }
          
          return;
        }

        // è¨ˆç®—æ™‚é–“
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // æª¢æŸ¥æ˜¯å¦æœ‰å¢åŠ ï¼Œé¡¯ç¤ºå‹•ç•«
        if (lastDays !== null && days > lastDays) {
          showAddTimeAnimation("+" + (days - lastDays), "days-unit");
        }
        if (lastHours !== null && hours > lastHours) {
          showAddTimeAnimation("+" + (hours - lastHours), "hours-unit");
        }
        if (lastMinutes !== null && minutes > lastMinutes) {
          showAddTimeAnimation("+" + (minutes - lastMinutes), "minutes-unit");
        }
        if (lastSeconds !== null && seconds > lastSeconds) {
          showAddTimeAnimation("+" + (seconds - lastSeconds), "seconds-unit");
        }

        // æ›´æ–°ä¸Šæ¬¡çš„å€¼
        lastDays = days;
        lastHours = hours;
        lastMinutes = minutes;
        lastSeconds = seconds;

        // å»ºç«‹é¡¯ç¤º
        let html = '';
        
        if (config.showDays && (days > 0 || config.showDays === true)) {
          html += `
            <div class="time-unit" id="days-unit">
              <div class="time-value">${days.toString().padStart(2, '0')}</div>
              <div class="time-label">å¤©</div>
            </div>
          `;
        }
        
        if (config.showHours) {
          html += `
            <div class="time-unit" id="hours-unit">
              <div class="time-value">${hours.toString().padStart(2, '0')}</div>
              <div class="time-label">æ™‚</div>
            </div>
          `;
        }
        
        if (config.showMinutes) {
          html += `
            <div class="time-unit" id="minutes-unit">
              <div class="time-value">${minutes.toString().padStart(2, '0')}</div>
              <div class="time-label">åˆ†</div>
            </div>
          `;
        }
        
        if (config.showSeconds) {
          html += `
            <div class="time-unit" id="seconds-unit">
              <div class="time-value">${seconds.toString().padStart(2, '0')}</div>
              <div class="time-label">ç§’</div>
            </div>
          `;
        }

        document.getElementById('countdownDisplay').innerHTML = html;
        
        // èª¿æ•´å´é‚Šåœ–ç‰‡é«˜åº¦èˆ‡è¨ˆæ™‚å™¨æ¡†æ¡†ç›¸åŒ
        adjustSideImagesHeight();
      }

      // é¡¯ç¤ºåŠ æ™‚é–“å‹•ç•«
      function showAddTimeAnimation(text, unitId) {
        const unitElement = document.getElementById(unitId);
        if (!unitElement) return;
        
        const valueElement = unitElement.querySelector('.time-value');
        if (!valueElement) return;
        
        const anim = document.createElement('span');
        anim.textContent = text;
        anim.className = 'add-time-animation';
        anim.style.left = (valueElement.offsetLeft + valueElement.offsetWidth / 2 - 20) + 'px';
        anim.style.top = (valueElement.offsetTop - 50) + 'px';
        
        document.querySelector('.countdown-display').appendChild(anim);
        
        setTimeout(() => {
          if (anim.parentNode) {
            anim.parentNode.removeChild(anim);
          }
        }, 2000);
      }

      // èª¿æ•´å´é‚Šåœ–ç‰‡é«˜åº¦
      function adjustSideImagesHeight() {
        const firstTimeUnit = document.querySelector('.time-unit');
        const leftImage = document.getElementById('leftImage');
        const rightImage = document.getElementById('rightImage');
        
        if (firstTimeUnit && leftImage && rightImage) {
          const unitHeight = firstTimeUnit.offsetHeight;
          if (unitHeight > 0) {
            leftImage.style.height = unitHeight + 'px';
            rightImage.style.height = unitHeight + 'px';
          }
        }
      }

      // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚å™¨
      function startCountdownInterval() {
        const interval = setInterval(() => {
          updateCountdown();
          
          // æª¢æŸ¥æ˜¯å¦å·²çµæŸ
          const now = new Date().getTime();
          const distance = targetTime - now;
          if (distance < 0) {
            clearInterval(interval);
          }
        }, 1000);
      }

    </script>
  </body>
</html>
